//- views/crypto.pug
//- Modified version from the shop-integration project
doctype html
html 
	head 
		include include/header.pug
		meta(name="robots" content="noindex")
	
		include include/header-css.pug
		
		if(ratio)
			title Preview payment
		else if(shift)
			title Shift payment
		else
			title Error


		link(rel='stylesheet' href='/css/payment-processor.css')
		link(rel='stylesheet' href='/css/style.css')
		link(rel='stylesheet' href='/css/table.css')
		
		//- QR style
		//- style.
		//- 	.qr-container {
		//- 		margin: 20px auto;
		//- 		display: inline-block;
		//- 		padding: 10px;
		//- 		border: 1px solid #ddd;
		//- 		border-radius: 5px;
		//- 		background: white;
		//- 	}
		//- 	canvas {
		//- 		margin: 10px 0;
		//- 	}

	body 
		div 
			if(ratio)
				h1 Donate to #{projectName}
				
				//- For demo virtual invoice
				if(!invoice)
					h2 Error - No invoice Data


				if(ratio.error)
					h2 API error
					if(ratio.error.message)
						p=ratio.error.message
				else
					-SHOP_SETTING = CURRENCY_SETTING
					-totalCrypto = Number(invoice.settleAmount / Number(ratio.rate)).toFixed(8)
					-invoiceTotal = Number(invoice.total).toLocaleString(SHOP_SETTING.locale,{style:'currency', currency: SHOP_SETTING.currency})
					


					form(method="post" action="/create-payment").form-checkout
						h1 Pay #{invoiceTotal} with
						img(src="/icons/"+ratio.depositCoin+"-"+ratio.depositNetwork+".svg" width="100px" height="100px")
						h2 #{ratio.depositCoin} (#{ratio.depositNetwork})
						
						if(invoice.isMemo === "true")
							p 
								b This coin need a Memo.
									br
									| Don't forget to set the destination wallet Memo when sending or your coins can be lost.
									br

						p Prepare to send nearby 
							b #{totalCrypto} #{ratio.depositCoin} (#{ratio.depositNetwork}).
						
						p Exact amout will be calculated next step.
						p You will have 
							b 15 minutes 
							| to send the coins, set everything before going to the next step.
						

						div.styleform
							input(type="hidden" name="coin" value=ratio.depositCoin )
							input(type="hidden" name="network" value=ratio.depositNetwork )
							input(type="hidden" name="total" value=invoice.total)
							input(type="hidden" name="id" value=invoice.id)
							input(type="hidden" name="donor" value=invoice.donor)
							input(type="hidden" name="refund" value=invoice.refund)

							button(type="submit").cool-button Go to Pay page
							br
							br
							if(ratio.depositCoin.toUpperCase().includes('USD'))
								h3 Why do I need to pay more than #{invoiceTotal}?
								p The total amount includes both your invoice and blockchain network fees. You're sending nearby #{totalCrypto} #{ratio.depositCoin} to ensure everything processes correctly.
									br
									br




			//- Shift payment page
			if(shift)
				if(shift.error)
					h3 API error
					p #{shift.error.message}
				else
					h1 Crowdfunding #{projectName}

					table
						tr
							th Payment ID
							td
								p #{shift.id}
						tr
							th Deposit coin
							td
								p
									b #{shift.depositCoin} (#{shift.depositNetwork})
						tr
							th Creation Date
							td
								p #{(new Date(shift.createdAt)).toLocaleString('en-EN')}
						tr
							th Expiration Date
							td
								p#EXPIREAT #{(new Date(shift.expiresAt)).toLocaleString('en-EN')}


					div#MESSAGE
						if(shift.status == "waiting")
							h2 Waiting for payment

						else if(shift.status == "pending")
							h2 Payment detected, waiting confirmation

						else if(shift.status == "processing")
							h2 Deposit confirmed

						else if(shift.status == "settling")
							h2 Payment near 100% completed
						
						else if(shift.status == "settled")
							h2.validated Payment completed !
							//- REDIRECT TO SUCCESS PAGE, done from server side
						
						else if(shift.status == "expired")
							h2.expired Payment address expired !
							//- REDIRECT TO CANCEL PAGE
							
						else
							h2 Invalid status


					if(shift.status != "expired")
						img(src="/icons/"+shift.depositCoin+"-"+shift.depositNetwork+".svg" width="100px" height="100px" class="flip-animation")
						h2 #{shift.depositCoin} (#{shift.depositNetwork})
						

					if(shift.status != "expired")
						-averageShiftMinutes = Math.floor(shift.averageShiftSeconds / 60);
						if(averageShiftMinutes > 0)
							p Average shift processing delay: #{averageShiftMinutes} minute(s) once pending
						else 
							p Average shift processing delay: less than 1 minute once pending


						if(shift.status != "expired")
							table
								tr
									if(shift.status == "waiting")
										th Send
									else
										th Amount
									td #{shift.depositAmount}
								tr
									if(shift.status == "waiting")
										th To
									else
										th Destination Wallet
									if(!depositLink)
										td #{shift.depositAddress}
									else
										td(style="border-bottom: 0px solid black; ") 
											a(href=depositLink target="_blank") #{shift.depositAddress}
								tr 
									//- QR code
									td(colspan="2")
										div(style="text-align:center;padding:0; margin:0;")
											.qr-container
												canvas#qrcode

								//- Memo
								if(shift.depositMemo)
									tr
										th Wallet Memo
										td #{shift.depositMemo}
			


					a(href="/cancel-shift/"+shift.id)
						button.btn Cancel Payment

					br
					br


if(shift)
	script(src="/js/qrious.min.js")
	//- script(src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js")

	script.
		// Initialize QR code
		const shiftData = !{JSON.stringify(shift)};

		const url = shiftData.depositAddress;
		if(url){
			function generateQR(url) {
				const qr = new QRious({
					element: document.getElementById('qrcode'),
					value: url,
					size: 200,
					level: 'H',
					background: 'white',
					foreground: 'black'
				});
			}
			generateQR(url)			
		}
	
		let now = Date.now();
		let expireAt = new Date(shiftData.expiresAt).valueOf();
		let timer = ( ( (Number(expireAt) - Number(now)) /1000 ) /60 ).toFixed(0);
		timer = Math.round(timer);

		document.getElementById("EXPIREAT").innerText = timer < 0 ? "Expired" : timer + " min";
		//- document.getElementById("EXPIREAT").innerText = Timer +" min";
		//- if(Timer < 0){
		//- 	document.getElementById("EXPIREAT").innerText = "Expired";
		//- } else{
		//- 	if(Timer === "-0") document.getElementById("EXPIREAT").innerText = "0 min";
		//- 	document.getElementById("EXPIREAT").innerText = Timer +" min";
		//- }

		function autoRefresh() {
			const status = shiftData.status;
			if(status !== "expired" && status !== "settled") location.reload();
		}
		
		setTimeout(autoRefresh, 20000);